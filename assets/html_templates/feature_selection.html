<div class="tab-content" id="feature-selection">

<section class="page-section">
    <h2>Feature Selection Results</h2>
    
    <div class="alert alert-info">
        <strong>Feature Selection Overview:</strong> This section presents the results of feature selection analysis 
        performed for each cell type. Feature selection identifies the most informative protein markers for 
        distinguishing each cell type, improving model performance and interpretability.
    </div>

    <!-- Overall Feature Selection Summary -->
    <div class="header-with-tooltip">
        <h3>Feature Selection Summary</h3>
        <div class="tooltip-container">
            <div class="tooltip-icon">i</div>
            <div class="tooltip-popup">
                Overview of feature selection results across all cell types processed in the analysis.
            </div>
        </div>
    </div>

    <div class="metrics-grid">
        <div class="metric-card">
            <div class="tooltip">
                <div class="metric-value">{{ feature_selection_data.total_original_features | default("N/A") }}</div>
                <div class="metric-label">Original Features</div>
                <div class="metric-description">Total markers available</div>
                <span class="tooltiptext">
                    Total number of protein markers available in the dataset before feature selection.
                </span>
            </div>
        </div>

        <div class="metric-card">
            <div class="tooltip">
                <div class="metric-value">{{ feature_selection_data.cell_types_processed | length | default("N/A") }}</div>
                <div class="metric-label">Cell Types Processed</div>
                <div class="metric-description">Number of cell types analyzed</div>
                <span class="tooltiptext">
                    Number of distinct cell types for which feature selection was performed.
                </span>
            </div>
        </div>

        <div class="metric-card">
            <div class="tooltip">
                <div class="metric-value">{{ "%.1f" | format(feature_selection_data.average_optimal_features) if feature_selection_data.average_optimal_features else "N/A" }}</div>
                <div class="metric-label">Average Optimal Features</div>
                <div class="metric-description">Mean features selected per cell type</div>
                <span class="tooltiptext">
                    Average number of features selected as optimal across all cell types analyzed.
                </span>
            </div>
        </div>

        <div class="metric-card">
            <div class="tooltip">
                <div class="metric-value">{{ feature_selection_data.cell_types_processed | join(", ") if feature_selection_data.cell_types_processed else "N/A" }}</div>
                <div class="metric-label">Cell Types</div>
                <div class="metric-description">Types analyzed</div>
                <span class="tooltiptext">
                    List of cell types that underwent feature selection analysis.
                </span>
            </div>
        </div>
    </div>
</section>

{% if feature_selection_data.feature_selection_results %}
<!-- Cell Type Tabs Navigation -->
<section class="page-section">
    <div class="header-with-tooltip">
        <h3>Cell Type-Specific Results</h3>
        <div class="tooltip-container">
            <div class="tooltip-icon">i</div>
            <div class="tooltip-popup">
                Detailed feature selection results for each cell type. Click on the tabs below to view results for individual cell types.
            </div>
        </div>
    </div>

    <style>
        .celltype-tabs {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 2rem;
            overflow-x: auto;
            flex-wrap: wrap;
        }

        .celltype-tab {
            padding: 0.75rem 1.5rem;
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-bottom: none;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s ease;
            margin-right: 2px;
            margin-bottom: 2px;
            border-radius: 6px 6px 0 0;
            min-width: 120px;
            text-align: center;
        }

        .celltype-tab:hover {
            background-color: #e9ecef;
        }

        .celltype-tab.active {
            background-color: white;
            border-bottom: 2px solid white;
            color: #667eea;
            font-weight: 600;
        }

        .celltype-content {
            display: none;
        }

        .celltype-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .celltype-tabs {
                flex-direction: column;
            }
            
            .celltype-tab {
                margin-right: 0;
                margin-bottom: 2px;
                border-radius: 6px;
                min-width: auto;
            }
        }
    </style>

    <!-- Cell Type Tabs -->
    <div class="celltype-tabs">
        {% for celltype_result in feature_selection_data.feature_selection_results %}
        <div class="celltype-tab {% if loop.first %}active{% endif %}" 
             onclick="showCellType('celltype-{{ loop.index0 }}')">
            {{ celltype_result.celltype }}
            <small style="display: block; font-size: 0.8em; color: #6c757d;">
                {{ celltype_result.optimal_features }} features
            </small>
        </div>
        {% endfor %}
    </div>

    <!-- Cell Type Content Panels -->
    {% for celltype_result in feature_selection_data.feature_selection_results %}
    <div id="celltype-{{ loop.index0 }}" class="celltype-content {% if loop.first %}active{% endif %}">
        
        <!-- Cell Type Overview -->
        <div class="header-with-tooltip">
            <h4>{{ celltype_result.celltype }} Feature Selection</h4>
            <div class="tooltip-container">
                <div class="tooltip-icon">i</div>
                <div class="tooltip-popup">
                    Feature selection results specifically for {{ celltype_result.celltype }} cells.
                </div>
            </div>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="tooltip">
                    <div class="metric-value">{{ celltype_result.original_features }}</div>
                    <div class="metric-label">Original Features</div>
                    <div class="metric-description">Starting feature count</div>
                    <span class="tooltiptext">
                        Number of features available before feature selection for this cell type.
                    </span>
                </div>
            </div>

            <div class="metric-card">
                <div class="tooltip">
                    <div class="metric-value">{{ celltype_result.optimal_features }}</div>
                    <div class="metric-label">Optimal Features</div>
                    <div class="metric-description">Selected feature count</div>
                    <span class="tooltiptext">
                        Number of features selected as optimal for classifying this cell type.
                    </span>
                </div>
            </div>

            <div class="metric-card">
                <div class="tooltip">
                    <div class="metric-value">{{ "%.1f" | format((celltype_result.optimal_features / celltype_result.original_features * 100)) if celltype_result.original_features > 0 else "N/A" }}%</div>
                    <div class="metric-label">Reduction Rate</div>
                    <div class="metric-description">Features retained</div>
                    <span class="tooltiptext">
                        Percentage of original features retained after selection process.
                    </span>
                </div>
            </div>

            <div class="metric-card">
                <div class="tooltip">
                    <div class="metric-value">{{ celltype_result.data.generation_time.split(' ')[0] if celltype_result.data.generation_time else "N/A" }}</div>
                    <div class="metric-label">Analysis Date</div>
                    <div class="metric-description">When analysis was run</div>
                    <span class="tooltiptext">
                        Date when feature selection was performed for this cell type.
                    </span>
                </div>
            </div>
        </div>

        <!-- Feature Selection Process Details -->
        {% if celltype_result.data.feature_selection_summary %}
        <div class="header-with-tooltip">
            <h5>Feature Selection Process</h5>
            <div class="tooltip-container">
                <div class="tooltip-icon">i</div>
                <div class="tooltip-popup">
                    Details about the feature selection process and filtering steps applied.
                </div>
            </div>
        </div>

        <div class="metrics-grid">
            <div class="metric-card">
                <div class="tooltip">
                    <div class="metric-value">{{ celltype_result.data.feature_selection_summary.original_features }}</div>
                    <div class="metric-label">Initial Features</div>
                    <div class="metric-description">Before any filtering</div>
                    <span class="tooltiptext">
                        Total features before any preprocessing or filtering steps.
                    </span>
                </div>
            </div>

            <div class="metric-card">
                <div class="tooltip">
                    <div class="metric-value">{{ celltype_result.data.feature_selection_summary.non_variant_removed | default("N/A") }}</div>
                    <div class="metric-label">Non-Variant Removed</div>
                    <div class="metric-description">Low-variance features</div>
                    <span class="tooltiptext">
                        Number of features removed due to low or zero variance across samples.
                    </span>
                </div>
            </div>

            <div class="metric-card">
                <div class="tooltip">
                    <div class="metric-value">{{ celltype_result.data.feature_selection_summary.features_after_variance_filter | default("N/A") }}</div>
                    <div class="metric-label">After Variance Filter</div>
                    <div class="metric-description">Remaining features</div>
                    <span class="tooltiptext">
                        Number of features remaining after variance filtering step.
                    </span>
                </div>
            </div>

            <div class="metric-card">
                <div class="tooltip">
                    <div class="metric-value">{{ celltype_result.data.optimal_n_features }}</div>
                    <div class="metric-label">Final Selection</div>
                    <div class="metric-description">Optimal feature count</div>
                    <span class="tooltiptext">
                        Final number of features selected as optimal for this cell type classification.
                    </span>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Visualization Plots -->
        <div class="header-with-tooltip">
            <h5>Feature Selection Visualizations</h5>
            <div class="tooltip-container">
                <div class="tooltip-icon">i</div>
                <div class="tooltip-popup">
                    Visual representations of the feature selection process and results for {{ celltype_result.celltype }}.
                </div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
            {% if celltype_result.data.alpha_plot_path and embedded_images[celltype_result.data.alpha_plot_path] %}
            <div class="plot-container">
                <div class="plot-title">Alpha Optimization</div>
                <img src="{{ embedded_images[celltype_result.data.alpha_plot_path] }}" alt="Alpha Optimization Plot" class="embedded-image" />
                <p style="font-size: 0.9em; color: #6c757d; margin-top: 0.5rem;">
                    Optimization of regularization parameter (alpha) for feature selection.
                </p>
            </div>
            {% endif %}

            {% if celltype_result.data.feature_ranking_plot_path and embedded_images[celltype_result.data.feature_ranking_plot_path] %}
            <div class="plot-container">
                <div class="plot-title">Feature Ranking</div>
                <img src="{{ embedded_images[celltype_result.data.feature_ranking_plot_path] }}" alt="Feature Ranking Plot" class="embedded-image" />
                <p style="font-size: 0.9em; color: #6c757d; margin-top: 0.5rem;">
                    Ranking of features by importance for {{ celltype_result.celltype }} classification.
                </p>
            </div>
            {% endif %}

            {% if celltype_result.data.rfe_plot_path and embedded_images[celltype_result.data.rfe_plot_path] %}
            <div class="plot-container">
                <div class="plot-title">RFE Analysis</div>
                <img src="{{ embedded_images[celltype_result.data.rfe_plot_path] }}" alt="RFE Analysis Plot" class="embedded-image" />
                <p style="font-size: 0.9em; color: #6c757d; margin-top: 0.5rem;">
                    Recursive Feature Elimination analysis showing performance vs. number of features.
                </p>
            </div>
            {% endif %}
        </div>

        <!-- Binary Counts Table (if available) -->
        {% if celltype_result.data.binary_count_table_path %}
        <div class="header-with-tooltip">
            <h5>Binary Classification Counts</h5>
            <div class="tooltip-container">
                <div class="tooltip-icon">i</div>
                <div class="tooltip-popup">
                    Sample counts for binary classification ({{ celltype_result.celltype }} vs. all other cell types).
                </div>
            </div>
        </div>

        <div class="alert alert-info">
            <strong>Binary Counts Data:</strong> Detailed binary classification counts are available in: 
            <code>{{ celltype_result.data.binary_count_table_path }}</code>
        </div>
        {% endif %}

        <!-- RFE Summary (if available) -->
        {% if celltype_result.data.rfe_summary_csv_path %}
        <div class="header-with-tooltip">
            <h5>RFE Summary</h5>
            <div class="tooltip-container">
                <div class="tooltip-icon">i</div>
                <div class="tooltip-popup">
                    Summary of Recursive Feature Elimination results for {{ celltype_result.celltype }}.
                </div>
            </div>
        </div>

        <div class="alert alert-info">
            <strong>RFE Summary Data:</strong> Detailed RFE analysis results are available in: 
            <code>{{ celltype_result.data.rfe_summary_csv_path }}</code>
        </div>
        {% endif %}
    </div>
    {% endfor %}
</section>

<script>
function showCellType(celltypeId) {
    // Hide all celltype content
    var contents = document.getElementsByClassName('celltype-content');
    for (var i = 0; i < contents.length; i++) {
        contents[i].classList.remove('active');
    }
    
    // Remove active class from all tabs
    var tabs = document.getElementsByClassName('celltype-tab');
    for (var i = 0; i < tabs.length; i++) {
        tabs[i].classList.remove('active');
    }
    
    // Show selected celltype content
    document.getElementById(celltypeId).classList.add('active');
    
    // Add active class to clicked tab
    event.target.classList.add('active');
}
</script>

{% else %}
<section class="page-section">
    <div class="alert alert-warning">
        <strong>No Feature Selection Data Available:</strong> No feature selection results were found. This may indicate 
        that feature selection was not performed or the results files are missing.
    </div>
</section>
{% endif %}

</div>